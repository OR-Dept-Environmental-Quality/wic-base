---
title: "Compare WIC factors over time and to competing sources"
output: html_notebook
---

This is a placeholder file.  Eventually I would like to write a markdown analysis or app that compares WIC impact factors over time and shows how they match up to competing sources, such as WARM.

below: some random old junk about how to import WARm..  needs to be fixed.


### Importing WARM impact factors 

I downloaded WARM impact factors from [here](https://www.epa.gov/sites/production/files/2019-06/warm_v15.xls) into a local directory.

Now let's make it an R data frame.

```{r}
warmGHGimported <-
  read_xls(
    path = "impact_factors/warm_v15.xls", 
    sheet = "Analysis Results (MTCO2E)", 
    range = "e12:k71", 
    col_names = c(
      "warmMaterial",
      "production",
      "recycling",
      "landfilling",
      "combustion",
      "composting",
      "anaerobicDigestion"
    ),
    col_types = c("text", rep("numeric",6))
  )

warmEnergyImported <-
  read_xls(
    path = "impact_factors/warm_v15.xls", 
    sheet = "Analysis Results (energy)", 
    range = "e12:k71", 
    col_names = c(
      "warmMaterial",
      "production",
      "recycling",
      "landfilling",
      "combustion",
      "composting",
      "anaerobicDigestion"
    ),
    col_types = c("text", rep("numeric",6))
  )
  
```

Now make this into a tidy data frame...
That means each datum is identified by classification variables in each row... the "long skinny" format. So I need each impactFactor to be identified by..

impactCategory
impactUnits
warmMaterial
disposition

```{r}
# flipping the GHG file to make it skinnier
warmGHGflipped <-
  warmGHGimported %>%
  pivot_longer(
    cols = production:anaerobicDigestion,
    names_to = "disposition",
    values_to = "impactFactor"
  ) %>%
  # adding more identifying variables
  mutate(
    impactCategory = "Global warming",
    impactUnits = "MTCO2E"
  )
# flipping the energy file to make it skinnier
warmEnergyFlipped <-
  warmEnergyImported %>%
  pivot_longer(
    cols = production:anaerobicDigestion,
    names_to = "disposition",
    values_to = "impactFactor"
  ) %>%
  # adding more identifying variables
  mutate(
    impactCategory = "Energy use",
    impactUnits = "million BTU"
  )
# merging those two files
warmFactors <-
  bind_rows(warmEnergyFlipped, warmGHGflipped)
```

ok, the WARM factors are in the object warmFactors.  I can get rid of temporary objects.

```{r}
rm(list=setdiff(ls(),c("warmFactors", "impact_factors_deq")))
```

### Merge DEQ and WARM factors

Now I need to do something that's not exactly a "reproducible" task.  I need to create a table that matches the material (and disposition?) names in the DEQ and WARM data sets.

Once I have this table, I won't need to rerun the code (and manual edits) that created it.

Let's explore the two sets a bit.
Are their disposition names the same?

```{r}
print(unique(impact_factors_deq$disposition))
print(unique(warmFactors$disposition))
```

their disposition names look compatible.  So I don't need to fix those.  Whew!

let's explore the material names... 

... did that.  

I have constructed a file that matches DEQ material names to WARM material names.  This may need to be altered as DEQ's own database expands.  I'll import it here.

```{r}
deqWARMxwalk <- 
  read_excel(
    "impact_factors/warm_oregon_deq_xwalk.xlsx",
    range="a5:b27"
  )
```

Now let's apply that crosswalk to the warmFactors, so that the warmFactors have deq material names.

```{r}
warmFactorsWithDEQnames <-
  left_join(
    warmFactors,
    deqWARMxwalk,
    by = "warmMaterial"
  )
```

Now I need to Assure that the units are compatible

Let's print out the categories and units in the DEQ file, and then the WARM file.

```{r}
distinct(impact_factors_deq, impactCategory, impactUnits)
distinct(warmFactorsWithDEQnames, impactCategory, impactUnits)
```

Differences:

* the DEQ file does GHG impacts as kg CO2 Eq. per short ton of material.
* the WARM file does GHG impacts as metric tons CO2 per short ton of material
* the DEQ file does energy as MJ
* the WARM file does GHG impacts as million BTU

So: I've got to

* multiply WARM's GHG numbers by 1000 (because there are 1000 kg in a metric ton)
* multiply WARM's energy numbers by 1055 (because there are  1,055.055853 MJ  in 1 million BTU).

Here I'll make those corrections, and also flip the sign on WARM's "production" impacts... because they count them as "savings" ((???!))

```{r}
warmFactorsWithDEQnamesUnitsCompatible <-
  warmFactorsWithDEQnames %>%
  mutate(
    impactFactor =
      case_when(
        impactCategory == "Energy use" ~ impactFactor*1055.0558,
        impactCategory == "Global warming" ~ impactFactor*1000
      ),
    impactUnits =
      case_when(
        impactCategory == "Energy use" ~ "MJ",
        impactCategory == "Global warming" ~ "kg CO2 eq."
      )
  ) %>%
  mutate(
    impactFactor =
      ifelse(disposition=="production", -impactFactor, impactFactor)
  )
```

I also need to add WARM names to the existing DEQ impact factors.

```{r}
impactFactorsDEQplusWARMnames <-
  left_join(
    impact_factors_deq,
    deqWARMxwalk,
    by="material"
  )
```


### Combine the sources

While I combine the DEQ and WARM files, I'm going to label the records with a source (DEQ or WARM) and also group the impact categories.

```{r}
impactSourcesToCompare <-
  bind_rows(
    impactFactorsDEQplusWARMnames %>%
      mutate(
        ifSource = "DEQ",
        impactGroup =
          case_when(
            impactCategory == "Air PM2.5" ~ "Air",
            impactCategory == "Energy demand" ~ "Energy",
            impactCategory == "Eutrophication" ~ "Eutrophication",
            impactCategory == "Global warming 100" |
              impactCategory == "Global warming 100(B)" |
              impactCategory == "Global warming 20" |
              impactCategory == "Global warming 20(B)" ~ "GHG's",
            impactCategory == "Human toxicity" ~ "Toxicity",
            impactCategory == "Water consumption" ~ "Water"
          )
      ),
    warmFactorsWithDEQnamesUnitsCompatible %>%
      mutate(
        ifSource = "WARM",
        impactGroup =
          case_when(
            impactCategory == "Global warming" ~ "GHG's",
            impactCategory == "Energy use" ~ "Energy"
          )
      )
  ) %>%
  # filtering out extra records from the WARM file (materials
  # not considered by Oregon DEQ)
  filter(!is.na(material) & !is.na(impactFactor)) %>%
  # sorting for convenience
  arrange(
    material,
    disposition,
    impactGroup,
    ifSource,
    impactCategory
  ) %>%
  # filling in LCstage field missing from WARM data
  mutate(
    LCstage=
      ifelse(
        ifSource=="WARM" & is.na(LCstage),
        ifelse(disposition=="production","production","endOfLife"),
        LCstage
      )
  )
```

Looks like it's done, so I can delete temp ohjects.

```{r}
rm(list=setdiff(ls(),"impactSourcesToCompare"))
```

I need a few more fixes.  The WARM impact categories need to be labeled as such for clarity.

And some spurious entries from WARM (e.g. composting aluminum) which have missing impact factors need to be removed.
 
```{r}
impactSourcesToCompare2 <- 
  impactSourcesToCompare %>%
  mutate(
    impactCategory =
      ifelse(
        ifSource=="WARM",
        paste(impactCategory, " (WARM)", sep=""),
        impactCategory
      )
  ) %>%
  filter(!is.na(impactFactor))
```

### Saving the results for posterity

Now I need to split this into two files and export them

First, one to use in the impact factor comparison app -- this does not use end-of-life transport impacts.

```{r}
impactFactorComparisonData <-
  impactSourcesToCompare2 %>%
  filter(LCstage != "endOfLifeTransport")
write.csv(
  impactFactorComparisonData, 
  "../common_data/impactFactorComparisonData.csv",
  row.names = F
)
saveRDS(
  impactFactorComparisonData, 
  "../common_data/impactSourcesToCompare.RData"
)
myPivotedTable <-
  impactFactorComparisonData %>%
  arrange(impactGroup, ifSource, impactCategory, impactUnits) %>%
  filter(!is.na(impactFactor)) %>%
  pivot_wider(
    names_from = 
      c("impactGroup","ifSource","impactCategory","impactUnits"),
    values_from = impactFactor
  )
# exporting that 
saveRDS(
  myPivotedTable,
  "../common_data/pivoted_impact_factor_comparison.RData"
)
```


Meanwhile, the full impact factor file, for use by the rest of WIC, does not need the WARM reference material.

```{r}
impactFactors <-
  impactSourcesToCompare2 %>%
  select(-impactGroup, -ifSource, -warmMaterial) %>%
  filter(
    impactCategory != "Energy use (WARM)" & 
      impactCategory != "Global warming (WARM)" 
      # &
      # impactCategory != "Global warming 100(B)" &
      # impactCategory != "Global warming 100"
  )
write.csv(
  impactFactors,
  "../common_data/impactFactors.csv",
  row.names = F
)
saveRDS(
  impactFactors,
  "../common_data/impactFactors.RData"
)
```

Ok, that's it.  Ready to move on I think!

```{r}
rm(list=ls())
```